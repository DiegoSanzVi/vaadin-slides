<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="vaadin-slide.html">
<link rel="import" href="../bower_components/polymer/lib/utils/flattened-nodes-observer.html">

<dom-module id="vaadin-slides">
    <template>

        <style>
            :host([hidden]) {
                display: none !important;
            }

            /* Slideshow container */
            #slideshow-container {
                position: relative;
                background: #f1f1f1f1;
                min-height: 100px;
                min-width: 100px;
            }

            /* Next & previous buttons */
            .prev, .next {
                cursor: pointer;
                position: absolute;
                top: 50%;
                width: auto;
                margin-top: -30px;
                padding: 16px;
                color: #888;
                font-weight: bold;
                font-size: 20px;
                border-radius: 0 3px 3px 0;
                user-select: none;
            }

            /* Position the "next button" to the right */
            .next {
                position: absolute;
                right: 0;
                border-radius: 3px 0 0 3px;
            }

            /* On hover, add a black background color with a little bit see-through */
            .prev:hover, .next:hover {
                background-color: rgba(0, 0, 0, 0.8);
                color: white;
            }

            /* The dot/bullet/indicator container */
            .dot-container {
                text-align: center;
                padding: 20px;
                background: #ddd;
            }

            /* The dots/bullets/indicators */
            .dot {
                cursor: pointer;
                height: 15px;
                width: 15px;
                margin: 0 2px;
                background-color: #bbb;
                border-radius: 50%;
                display: inline-block;
                transition: background-color 0.6s ease;
            }

            /* Add a background color to the active dot/circle */
            .active, .dot:hover {
                background-color: #717171;
            }

            /*::slotted(vaadin-slide) {*/
                /*display: none;*/
            /*}*/

            /*::slotted(.active-slide) {*/
                /*display: block;*/
            /*}*/

        </style>
        <div id="slideshow-container">
            <slot>
                <vaadin-slide>
                    <img class="" src="https://www.w3schools.com/w3css/img_lights.jpg" style="width:100%">
                </vaadin-slide>
                <vaadin-slide>
                    <q>I love you the more in that I believe you had liked me for my
                        own sake and for nothing else</q>
                    <p class="author">- John Keats</p>
                </vaadin-slide>
            </slot>

            <a class="prev" on-click="previousSlide">❮</a>
            <a class="next" on-click="nextSlide">❯</a>

        </div>

        <div class="dot-container">
            <template is="dom-repeat" items="[[indexArray]]" as="slideIndex">
                <span class="dot" on-click="currentSlide" data-item$="[[slideIndex]]"></span>
            </template>
        </div>

    </template>

    <script>
        class VaadinSlides extends Polymer.Element {
            static get is() {
                return 'vaadin-slides';
            }

            static get properties() {

                return {
                    // Declare your properties here.
                    slideIndex: {
                        type: Number,
                        value: 0,
                        observer: '_slideChanged',
                        notify: true
                    },
                    slidesNumber: {
                        type: Number,
                        value: 0,
                        observer: '_slideChanged'
                    },

                    indexArray: {
                        type: Array
                    }
                };
            }

            // Polymer.Element's shadowRoot is created in connectedCallback so you can only access it after calling super.connectedCallback

            ready() {
                super.ready();

                var registration = new Polymer.FlattenedNodesObserver(this.shadowRoot.querySelector("slot"), (info) => {
                    this.indexArray = this._getChildrenIndexes();
                    this.slidesNumber = this.indexArray.length;
                });

            }

            _getChildrenIndexes() {
                const array = [];
                for (let index = 0; index < this._getSlides().length; index++) {
                    array.push(index)
                }
                return array;
            }

            _slideChanged() {
                if (!this._isSlideInRange(this.slideIndex)){
                    if ( this.slideIndex < 0){
                        this.slideIndex = Math.max(0,this.slidesNumber - 1);
                    } else {
                        this.slideIndex = 0;
                    }
                }

                this.showSlide(this.slideIndex);
            }

            //////
            currentSlide(event) {
                alert("You clicked me!" +  event.target.dataset.item);
                let selectedSlideIndex =  parseInt(event.target.dataset.item);
                if (!isNaN(selectedSlideIndex)) {
                    this.slideIndex = selectedSlideIndex;
                }
            }


            nextSlide() {
                this.slideIndex += 1;
            }

            previousSlide() {
                this.slideIndex -= 1;
            }

            //////////////



            showSlide(n) {
                this._hideAllSlides();
                this._hideAllDots();

                if (this.slidesNumber > 0){ // when it is not empty
                    let slides = this._getSlides();
                    let dots = this._getDots();

                    if (slides && slides.length > 0)
                        slides[this.slideIndex].removeAttribute("hidden");
                    if (dots && dots.length > 0)
                        dots[this.slideIndex].className += " active";
                }
            }

            _hideAllSlides() {
                let slides = this._getSlides();

                for (let i = 0; i < slides.length; i++) {
                    slides[i].setAttribute("hidden","");
                }
            }

            _hideAllDots() {
                let dots = this._getDots();

                for (let i = 0; i < dots.length; i++) {
                    dots[i].className = dots[i].className.replace(" active", "");
                }
            }

            _isSlideInRange(slide){
                return (slide >= 0 && slide < this.slidesNumber);
            }

            _getSlides() {
                return this.shadowRoot.querySelectorAll("vaadin-slide");
            }

            _getDots() {
                return this.shadowRoot.querySelectorAll(".dot");
            }

        }

        customElements.define(VaadinSlides.is, VaadinSlides);
    </script>
</dom-module>